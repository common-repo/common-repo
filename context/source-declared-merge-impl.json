{
  "plan_name": "Source-Declared Merge Implementation",
  "description": "Add defer flag to operators for source-declared merge behavior",
  "created": "2025-12-31",
  "last_updated": "2026-01-01T10:15:00Z",
  "parent_plan": "context/source-declared-merge.json",
  "design_document": "context/source-declared-merge-design.md",
  "approach": "Option 6: Add defer flag to existing operators, use existing list format for source configs",
  "phases": [
    {
      "id": "phase-1",
      "name": "Add defer field",
      "description": "Add defer: bool field to operator structs"
    },
    {
      "id": "phase-2",
      "name": "Apply deferred ops",
      "description": "Collect and apply deferred operations from source repos"
    }
  ],
  "tasks": [
    {
      "id": "add-defer-field",
      "name": "Add defer and auto-merge fields to operator structs",
      "status": "complete",
      "priority": 1,
      "phase": "phase-1",
      "blocked_by": null,
      "steps": [
        "Add defer: Option<bool> to all merge operator structs",
        "Add auto_merge: Option<String> to all merge operator structs",
        "Add validation: auto-merge implies defer=true",
        "Add validation: error if auto-merge used with source/dest",
        "When auto-merge set, populate source=dest from its value",
        "Update schema.yaml with defer and auto-merge documentation",
        "Add unit tests for both fields"
      ],
      "acceptance_criteria": [
        "All merge operator structs have defer and auto-merge fields",
        "defer: true parses correctly",
        "auto-merge: CLAUDE.md sets source=dest=CLAUDE.md and defer=true",
        "Error if auto-merge used with explicit source/dest",
        "cargo test passes"
      ],
      "files_to_modify": [
        "src/config.rs",
        "schema.yaml"
      ],
      "complexity": "low"
    },
    {
      "id": "parse-top-level-ops",
      "name": "Parse top-level operators in config",
      "status": "skipped",
      "priority": 2,
      "phase": "phase-1",
      "blocked_by": "add-defer-field",
      "skip_reason": "Not needed - existing list format (- markdown: {...}) already parses operators at root level with proper ordering. Root-level mapping format would lose operator ordering since YAML doesn't guarantee key order.",
      "steps": [],
      "acceptance_criteria": [],
      "files_to_modify": [],
      "complexity": "n/a"
    },
    {
      "id": "apply-deferred-ops",
      "name": "Apply deferred operations from source repos",
      "status": "complete",
      "priority": 3,
      "phase": "phase-2",
      "blocked_by": null,
      "steps": [
        "When loading source repo, parse its .common-repo.yaml",
        "Extract operations where defer: true or auto-merge is set",
        "Apply deferred ops before consumer with: operations",
        "Ensure consumer ops override deferred ops for same dest"
      ],
      "acceptance_criteria": [
        "Deferred ops from source apply automatically",
        "Consumer with: takes precedence",
        "Source without .common-repo.yaml works normally"
      ],
      "files_modified": [
        "src/config.rs (added Operation::is_deferred())",
        "src/phases/discovery.rs (added extract_deferred_operations, modified discover_inherited_configs)"
      ],
      "complexity": "medium"
    },
    {
      "id": "add-e2e-tests",
      "name": "Add end-to-end tests",
      "status": "complete",
      "priority": 4,
      "phase": "phase-2",
      "blocked_by": null,
      "steps": [
        "Test: source repo with deferred markdown merge",
        "Test: consumer with: overrides deferred op",
        "Test: source without config (normal copy)",
        "Test: multiple deferred operations"
      ],
      "acceptance_criteria": [
        "E2E tests cover main scenarios",
        "All tests pass"
      ],
      "files_created": [
        "tests/cli_e2e_defer.rs"
      ],
      "test_results": {
        "passing": 20,
        "failing": 0
      },
      "complexity": "medium"
    },
    {
      "id": "fix-auto-merge-support",
      "name": "Fix auto-merge support for all merge types",
      "status": "complete",
      "priority": 3.5,
      "phase": "phase-2",
      "blocked_by": null,
      "steps": [
        "Add auto-merge support to TOML merge in src/merge/toml.rs",
        "Add auto-merge support to INI merge if missing",
        "Update validate command to call operation.validate() methods",
        "Ensure all merge types handle auto-merge consistently"
      ],
      "acceptance_criteria": [
        "TOML merge works with auto-merge: Cargo.toml",
        "validate command catches auto-merge + source/dest conflicts",
        "All E2E defer tests pass"
      ],
      "files_modified": [
        "src/config.rs (changed TomlMergeOp.path from String to Option<String>)",
        "src/merge/toml.rs (updated path handling for Option<String>)",
        "src/commands/validate.rs (added validation calls for all merge operation types)",
        "tests/cli_e2e_defer.rs (fixed tests to check stdout instead of stderr)"
      ],
      "complexity": "medium"
    },
    {
      "id": "update-docs",
      "name": "Update documentation",
      "status": "pending",
      "priority": 5,
      "phase": "phase-2",
      "blocked_by": "add-e2e-tests",
      "steps": [
        "Add defer flag to docs/src/authoring-source-repos.md",
        "Add examples for common use cases",
        "Update configuration.md with defer syntax"
      ],
      "acceptance_criteria": [
        "Authoring guide documents defer flag",
        "Examples are clear"
      ],
      "files_to_modify": [
        "docs/src/authoring-source-repos.md",
        "docs/src/configuration.md"
      ],
      "complexity": "low"
    }
  ],
  "complexity_estimate": {
    "total_tasks": 4,
    "estimated_loc": "100-200",
    "key_changes": [
      "Add defer and auto-merge fields to merge operator structs",
      "Validation: auto-merge implies defer, conflicts with source/dest",
      "Thread deferred ops through apply workflow"
    ]
  },
  "notes": [
    "No new file name - uses existing .common-repo.yaml",
    "Two forms: defer: true (verbose) or auto-merge: file (shorthand)",
    "auto-merge: CLAUDE.md sets source=dest=CLAUDE.md and implies defer",
    "Consumer with: implicitly overrides deferred ops",
    "Source configs use standard list format (- markdown: {...}) to preserve operator ordering"
  ]
}
