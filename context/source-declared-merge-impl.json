{
  "plan_name": "Source-Declared Merge Implementation",
  "description": "Implementation plan using existing operator syntax in .common-repo-source.yaml",
  "created": "2025-12-31",
  "last_updated": "2025-12-31",
  "parent_plan": "context/source-declared-merge.json",
  "design_document": "context/source-declared-merge-design.md",
  "approach": "Option 6: Reuse existing operator syntax - minimal new code required",
  "phases": [
    {
      "id": "phase-1",
      "name": "Parse Source Config",
      "description": "Parse .common-repo-source.yaml using existing config parser"
    },
    {
      "id": "phase-2",
      "name": "Apply Source Operations",
      "description": "Apply source-declared operations during repo processing"
    },
    {
      "id": "phase-3",
      "name": "Documentation & Testing",
      "description": "E2E tests and documentation updates"
    }
  ],
  "tasks": [
    {
      "id": "parse-source-config",
      "name": "Parse .common-repo-source.yaml",
      "status": "pending",
      "priority": 1,
      "phase": "phase-1",
      "blocked_by": null,
      "steps": [
        "Add constant for source config filename (.common-repo-source.yaml)",
        "Create function to look for and parse source config in repo",
        "Reuse existing parse_with_clause() or similar for 'with:' field",
        "Return Vec<Operation> or None if no source config",
        "Add unit tests for parsing"
      ],
      "acceptance_criteria": [
        "Source config parsed using existing Operation types",
        "Missing config returns None gracefully",
        "Invalid config returns descriptive error",
        "cargo test passes"
      ],
      "files_to_modify": [
        "src/config.rs (add parse function)",
        "src/lib.rs (add constant if needed)"
      ],
      "complexity": "low",
      "notes": "Leverage existing parse_operations() logic"
    },
    {
      "id": "integrate-source-ops",
      "name": "Apply source operations in processing flow",
      "status": "pending",
      "priority": 2,
      "phase": "phase-2",
      "blocked_by": "parse-source-config",
      "steps": [
        "Identify where repo files are processed (apply command flow)",
        "After loading repo, check for .common-repo-source.yaml",
        "Parse source operations if present",
        "Apply source operations before consumer with: operations",
        "Ensure consumer operations override source for same dest file"
      ],
      "acceptance_criteria": [
        "Source operations apply automatically",
        "Consumer with: operations take precedence",
        "Files not in source config copy normally"
      ],
      "files_to_modify": [
        "src/lib.rs or src/operators.rs (processing flow)",
        "src/git.rs (if source config read during load)"
      ],
      "complexity": "medium",
      "notes": "Key integration point - most risk here"
    },
    {
      "id": "add-e2e-tests",
      "name": "Add end-to-end tests",
      "status": "pending",
      "priority": 3,
      "phase": "phase-3",
      "blocked_by": "integrate-source-ops",
      "steps": [
        "Create test fixture: source repo with .common-repo-source.yaml",
        "Test: markdown merge from source config",
        "Test: consumer with: overrides source merge",
        "Test: missing source config (normal copy)",
        "Test: source config with multiple operations"
      ],
      "acceptance_criteria": [
        "E2E tests cover main scenarios",
        "All tests pass with cargo nextest run"
      ],
      "files_to_modify": [
        "tests/cli_e2e_source_config.rs (new file)"
      ],
      "complexity": "low"
    },
    {
      "id": "update-docs",
      "name": "Update documentation",
      "status": "pending",
      "priority": 4,
      "phase": "phase-3",
      "blocked_by": "add-e2e-tests",
      "steps": [
        "Add section to docs/src/authoring-source-repos.md",
        "Document .common-repo-source.yaml format",
        "Add examples for common use cases",
        "Update schema.yaml if needed"
      ],
      "acceptance_criteria": [
        "Authoring guide documents source config",
        "Examples are clear and tested"
      ],
      "files_to_modify": [
        "docs/src/authoring-source-repos.md",
        "schema.yaml (optional)"
      ],
      "complexity": "low"
    }
  ],
  "complexity_estimate": {
    "total_tasks": 4,
    "phase_1_tasks": 1,
    "phase_2_tasks": 1,
    "phase_3_tasks": 2,
    "estimated_loc": "100-200",
    "reduction_from_original": "Reduced from 9 tasks to 4 by reusing existing types",
    "key_simplifications": [
      "No new SourceManifest types - reuse Operation enum",
      "No new validation - existing operator validation works",
      "No new error types - existing ConfigError covers it",
      "No glob patterns in v1 - can add later"
    ]
  },
  "notes": [
    "This is significantly simpler than the original manifest approach",
    "Key insight: with: syntax already exists, just use it source-side",
    "Consumer override is implicit - any consumer with: for same dest wins",
    "Can extend later with glob patterns, defaults, etc. if needed"
  ]
}
