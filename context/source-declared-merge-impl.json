{
  "plan_name": "Source-Declared Merge Implementation",
  "description": "Add defer flag to operators for source-declared merge behavior",
  "created": "2025-12-31",
  "last_updated": "2025-12-31",
  "parent_plan": "context/source-declared-merge.json",
  "design_document": "context/source-declared-merge-design.md",
  "approach": "Option 6: Add defer flag to existing operators, parse top-level operators in .common-repo.yaml",
  "phases": [
    {
      "id": "phase-1",
      "name": "Add defer field",
      "description": "Add defer: bool field to operator structs"
    },
    {
      "id": "phase-2",
      "name": "Parse top-level operators",
      "description": "Parse operators at config root, not just under with:"
    },
    {
      "id": "phase-3",
      "name": "Apply deferred ops",
      "description": "Collect and apply deferred operations from source repos"
    }
  ],
  "tasks": [
    {
      "id": "add-defer-field",
      "name": "Add defer and auto-merge fields to operator structs",
      "status": "pending",
      "priority": 1,
      "phase": "phase-1",
      "blocked_by": null,
      "steps": [
        "Add defer: Option<bool> to all merge operator structs",
        "Add auto_merge: Option<String> to all merge operator structs",
        "Add validation: auto-merge implies defer=true",
        "Add validation: error if auto-merge used with source/dest",
        "When auto-merge set, populate source=dest from its value",
        "Update schema.yaml with defer and auto-merge documentation",
        "Add unit tests for both fields"
      ],
      "acceptance_criteria": [
        "All merge operator structs have defer and auto-merge fields",
        "defer: true parses correctly",
        "auto-merge: CLAUDE.md sets source=dest=CLAUDE.md and defer=true",
        "Error if auto-merge used with explicit source/dest",
        "cargo test passes"
      ],
      "files_to_modify": [
        "src/config.rs",
        "schema.yaml"
      ],
      "complexity": "low"
    },
    {
      "id": "parse-top-level-ops",
      "name": "Parse top-level operators in config",
      "status": "pending",
      "priority": 2,
      "phase": "phase-2",
      "blocked_by": "add-defer-field",
      "steps": [
        "Modify config parser to check for top-level operator keys",
        "Parse markdown:, yaml:, json:, toml:, ini:, copy:, etc. at root",
        "Collect these as deferred operations",
        "Ensure backward compatibility with existing configs"
      ],
      "acceptance_criteria": [
        "Top-level operators parse correctly",
        "Existing consumer configs still work",
        "Deferred ops collected separately from with: ops"
      ],
      "files_to_modify": [
        "src/config.rs"
      ],
      "complexity": "medium"
    },
    {
      "id": "apply-deferred-ops",
      "name": "Apply deferred operations from source repos",
      "status": "pending",
      "priority": 3,
      "phase": "phase-3",
      "blocked_by": "parse-top-level-ops",
      "steps": [
        "When loading source repo, parse its .common-repo.yaml",
        "Extract operations where defer: true",
        "Apply deferred ops before consumer with: operations",
        "Ensure consumer ops override deferred ops for same dest"
      ],
      "acceptance_criteria": [
        "Deferred ops from source apply automatically",
        "Consumer with: takes precedence",
        "Source without .common-repo.yaml works normally"
      ],
      "files_to_modify": [
        "src/lib.rs",
        "src/operators.rs"
      ],
      "complexity": "medium"
    },
    {
      "id": "add-e2e-tests",
      "name": "Add end-to-end tests",
      "status": "pending",
      "priority": 4,
      "phase": "phase-3",
      "blocked_by": "apply-deferred-ops",
      "steps": [
        "Test: source repo with deferred markdown merge",
        "Test: consumer with: overrides deferred op",
        "Test: source without config (normal copy)",
        "Test: multiple deferred operations"
      ],
      "acceptance_criteria": [
        "E2E tests cover main scenarios",
        "All tests pass"
      ],
      "files_to_modify": [
        "tests/cli_e2e_defer.rs (new)"
      ],
      "complexity": "low"
    },
    {
      "id": "update-docs",
      "name": "Update documentation",
      "status": "pending",
      "priority": 5,
      "phase": "phase-3",
      "blocked_by": "add-e2e-tests",
      "steps": [
        "Add defer flag to docs/src/authoring-source-repos.md",
        "Add examples for common use cases",
        "Update configuration.md with defer syntax"
      ],
      "acceptance_criteria": [
        "Authoring guide documents defer flag",
        "Examples are clear"
      ],
      "files_to_modify": [
        "docs/src/authoring-source-repos.md",
        "docs/src/configuration.md"
      ],
      "complexity": "low"
    }
  ],
  "complexity_estimate": {
    "total_tasks": 5,
    "estimated_loc": "150-250",
    "key_changes": [
      "Add defer and auto-merge fields to merge operator structs",
      "Validation: auto-merge implies defer, conflicts with source/dest",
      "Parse top-level operators in config",
      "Thread deferred ops through apply workflow"
    ]
  },
  "notes": [
    "No new file name - uses existing .common-repo.yaml",
    "Two forms: defer: true (verbose) or auto-merge: file (shorthand)",
    "auto-merge: CLAUDE.md sets source=dest=CLAUDE.md and implies defer",
    "Consumer with: implicitly overrides deferred ops",
    "Top-level operators are new but follow existing syntax"
  ]
}
