{
  "plan_name": "Init Command Redesign",
  "description": "Redesign common-repo init to be an interactive setup wizard with pre-commit integration",
  "created": "2025-12-29",
  "last_updated": "2025-12-31T09:00:00Z",
  "source": "context/session-notes.md",
  "tasks": [
    {
      "id": "add-dialoguer-dependency",
      "name": "Add dialoguer crate for interactive prompts",
      "status": "complete",
      "priority": 1,
      "blocked_by": null,
      "steps": [
        "Add dialoguer = \"0.11\" to Cargo.toml dependencies",
        "Run cargo check to verify dependency resolves"
      ],
      "acceptance_criteria": [
        "dialoguer is in Cargo.toml",
        "cargo check passes"
      ]
    },
    {
      "id": "implement-interactive-wizard",
      "name": "Implement full interactive setup wizard",
      "status": "complete",
      "priority": 2,
      "blocked_by": "add-dialoguer-dependency",
      "steps": [
        "Replace stub prompts in generate_interactive_config() with real dialoguer prompts",
        "Prompt for repository URLs (supports GitHub shorthand org/repo)",
        "Auto-fetch and detect latest semver tag from each repo",
        "Fall back to 'main' branch if no semver tags found",
        "Generate config with all added repos and default include pattern"
      ],
      "acceptance_criteria": [
        "common-repo init -i launches interactive wizard",
        "User can enter repo URLs interactively",
        "Latest semver is auto-detected for each repo"
      ]
    },
    {
      "id": "add-uri-positional-arg",
      "name": "Add URI positional argument for init from existing repo",
      "status": "pending",
      "priority": 2,
      "blocked_by": null,
      "steps": [
        "Add optional positional argument to InitArgs struct",
        "When URI provided, fetch repo metadata",
        "Auto-detect latest semver tag (including 0.x.x)",
        "Warn if no semver tags found or only 0.x.x versions",
        "Generate config with that repo as starting point"
      ],
      "acceptance_criteria": [
        "common-repo init https://github.com/org/repo creates config with that repo",
        "Latest semver tag is auto-detected for ref field",
        "Warning shown for 0.x.x versions"
      ]
    },
    {
      "id": "implement-precommit-setup",
      "name": "Add pre-commit hook setup to init wizard",
      "status": "pending",
      "priority": 3,
      "blocked_by": "implement-interactive-wizard",
      "steps": [
        "Add prompt asking if user wants pre-commit hooks",
        "Generate .pre-commit-config.yaml when selected",
        "Detect if prek or pre-commit CLI is available",
        "If available, offer to run hook installation (optional)",
        "Run prek install or pre-commit install if user agrees"
      ],
      "acceptance_criteria": [
        ".pre-commit-config.yaml created when hooks selected",
        "Hook installation runs if CLI detected and user agrees",
        "Works with both prek and pre-commit CLIs"
      ]
    },
    {
      "id": "update-install-script-prek",
      "name": "Add optional prek installation to install.sh",
      "status": "pending",
      "priority": 3,
      "blocked_by": null,
      "steps": [
        "Add INSTALL_PREK env var check to install.sh",
        "If INSTALL_PREK=1, install prek automatically",
        "If interactive (TTY), prompt user whether to install prek",
        "Download and install prek binary alongside common-repo",
        "Show success message with prek version"
      ],
      "acceptance_criteria": [
        "INSTALL_PREK=1 installs prek without prompting",
        "Interactive install prompts user about prek",
        "prek binary installed to same directory as common-repo"
      ]
    },
    {
      "id": "remove-deprecated-flags",
      "name": "Remove deprecated init flags (--minimal, --empty, --template)",
      "status": "pending",
      "priority": 4,
      "blocked_by": "implement-interactive-wizard",
      "steps": [
        "Remove --minimal, --empty flags from InitArgs",
        "Remove --template flag (superseded by URI arg)",
        "Remove generate_*_template() functions",
        "Update tests to reflect new behavior",
        "Default behavior becomes interactive wizard"
      ],
      "acceptance_criteria": [
        "common-repo init launches interactive wizard by default",
        "Old flags removed",
        "Tests updated and passing"
      ]
    },
    {
      "id": "update-init-documentation",
      "name": "Update documentation for new init behavior",
      "status": "pending",
      "priority": 5,
      "blocked_by": "remove-deprecated-flags",
      "steps": [
        "Update README.md quick start section",
        "Update docs/configuration.md if it references init",
        "Add examples of init with URI argument",
        "Document INSTALL_PREK env var"
      ],
      "acceptance_criteria": [
        "README reflects new init behavior",
        "URI argument documented with examples"
      ]
    },
    {
      "id": "add-init-e2e-tests",
      "name": "Add E2E tests for new init behavior",
      "status": "complete",
      "priority": 5,
      "blocked_by": "implement-interactive-wizard",
      "steps": [
        "Add rexpect as dev dependency for TTY simulation (cargo add rexpect --dev)",
        "Create tests/cli_e2e_init_interactive.rs for interactive wizard tests",
        "Use rexpect spawn_command to launch common-repo init -i",
        "Test: enter repo URL, verify semver detection output, enter empty to finish",
        "Test: enter invalid URL, verify error handling and fallback to main",
        "Test: enter GitHub shorthand (org/repo), verify URL expansion",
        "Add #[cfg(unix)] to interactive tests (rexpect requires *nix/WSL)",
        "Add non-interactive tests for init with URI positional arg (when implemented)",
        "Test .pre-commit-config.yaml generation (when implemented)"
      ],
      "acceptance_criteria": [
        "E2E tests cover interactive wizard with real TTY simulation",
        "Tests verify semver detection, URL normalization, error handling",
        "Interactive tests gated to unix platforms",
        "./script/test passes on Linux/macOS"
      ],
      "context": {
        "testing_approach": "Use rexpect crate for TTY simulation - dialoguer requires real terminal",
        "platform_limitation": "rexpect only works on *nix and WSL, not Windows native",
        "github_issue": "https://github.com/console-rs/dialoguer/issues/95 - no built-in test support",
        "key_functions_to_test": [
          "generate_interactive_config() - main wizard flow",
          "normalize_repo_url() - GitHub shorthand expansion",
          "find_latest_version() - semver tag selection",
          "build_config_from_repos() - YAML generation"
        ],
        "unit_tests_exist": "normalize_repo_url, find_latest_version, build_config_from_repos have unit tests in src/commands/init.rs"
      }
    }
  ],
  "notes": [
    "dialoguer is the standard Rust crate for interactive CLI prompts",
    "prek is a Rust-based pre-commit alternative that's faster than Python pre-commit",
    "Semver detection should handle both v1.0.0 and 1.0.0 tag formats",
    "0.x.x versions are valid semver but warrant a stability warning"
  ],
  "decisions": {
    "interactive_crate": {
      "chosen": "dialoguer",
      "alternatives_considered": ["inquire", "requestty", "console + manual prompts"],
      "rationale": "dialoguer is the most popular and well-maintained; no existing interactive crate in project"
    },
    "uri_argument_style": {
      "chosen": "Positional argument",
      "alternatives_considered": ["--from <URI> flag"],
      "rationale": "Cleaner UX for the common case: common-repo init https://github.com/org/repo"
    },
    "precommit_tool_support": {
      "chosen": "Support both prek and pre-commit CLI",
      "rationale": "prek preferred (Rust, faster) but pre-commit is more widely installed; detect and use whichever is available"
    },
    "prek_installation": {
      "chosen": "Prompt in interactive install, auto-install with INSTALL_PREK=1",
      "rationale": "Don't force installation, but make it easy to opt-in"
    },
    "default_behavior": {
      "chosen": "Interactive wizard by default (remove --minimal, --empty, --template flags)",
      "rationale": "Current default (dump example YAML) is not useful; wizard provides better onboarding"
    }
  },
  "future_enhancements": [
    {
      "id": "dogfood-precommit-config",
      "description": "Publish common-repo's own .pre-commit-config.yaml as a source repository",
      "rationale": "The pre-commit hook config common-repo uses should itself be a source repo that others can inherit. This dogfoods the tool and provides a real-world example.",
      "steps": [
        "Create a common-repo/precommit-rust source repo (or similar)",
        "Move .pre-commit-config.yaml content there",
        "Have common-repo itself inherit from that source",
        "Offer this as a default option in init wizard"
      ]
    },
    {
      "id": "base-template-registry",
      "description": "Offer choices for common base templates/configurations in wizard",
      "rationale": "Users should be able to pick from curated starting points rather than just a URI",
      "steps": [
        "Define a list of known good source repos (rust-cli, python-django, etc.)",
        "Allow wizard to present these as quick-start options",
        "Could be hardcoded initially, later fetched from a registry"
      ]
    }
  ]
}
