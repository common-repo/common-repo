{
  "plan_name": "Parallel Clones Implementation",
  "last_updated": "2025-12-02",
  "session_startup": [
    "Run git status to check branch",
    "Run ./script/test in background to verify baseline",
    "Read this file to find current task",
    "Find first task where status=pending and blocked_by=null"
  ],
  "context": {
    "current_state": "clone_parallel() in src/phases/discovery.rs:277-334 is sequential despite its name. It already uses breadth-first traversal (all repos at depth N before depth N+1). The structure is ready for parallelization.",
    "design_goal": "Clone repos at same depth level in parallel BY DEFAULT. Total time determined by tree depth, not breadth. Performance target: execution time approaches minimum network transfer time.",
    "cli_requirements": {
      "flag": "--parallel <n> for apply command - OPTIONAL override (default: auto/num_cpus)",
      "env_var": "COMMON_REPO_PARALLEL - OPTIONAL override for default parallel clone operations"
    },
    "implementation_approach": "Use rayon for parallel iteration. Parallelism is the DEFAULT behavior - no CLI flag needed to enable it. The --parallel flag only exists to limit/override. Rayon handles blocking I/O fine via thread pool.",
    "key_blocker": "RepositoryManager needs to be accessible across threads. Options: Arc wrapper, or Clone trait, or pass by reference with rayon's par_iter."
  },
  "tasks": [
    {
      "id": "add-rayon-dependency",
      "name": "Add rayon dependency to Cargo.toml",
      "status": "complete",
      "priority": 1,
      "blocked_by": null,
      "output_file": "Cargo.toml",
      "steps": [
        "Add rayon = \"1.10\" to [dependencies] in Cargo.toml",
        "Run cargo build to verify dependency resolves"
      ],
      "acceptance_criteria": [
        "rayon is listed in Cargo.toml dependencies",
        "cargo build succeeds"
      ]
    },
    {
      "id": "make-repo-manager-sync",
      "name": "Make RepositoryManager thread-safe for parallel access",
      "status": "complete",
      "priority": 2,
      "blocked_by": "add-rayon-dependency",
      "output_file": "src/repository.rs",
      "steps": [
        "Review RepositoryManager struct in src/repository.rs",
        "Ensure GitOperations and CacheOperations traits have Send + Sync bounds",
        "Verify RepositoryManager can be shared across threads (no interior mutability issues)",
        "Add Sync bound to RepositoryManager if needed",
        "Run cargo build to verify changes compile"
      ],
      "acceptance_criteria": [
        "RepositoryManager can be referenced from multiple threads",
        "cargo build succeeds",
        "Existing tests pass"
      ]
    },
    {
      "id": "implement-parallel-clone",
      "name": "Implement parallel cloning in clone_parallel() - DEFAULT behavior",
      "status": "complete",
      "priority": 3,
      "blocked_by": "make-repo-manager-sync",
      "output_file": "src/phases/discovery.rs",
      "steps": [
        "Import rayon::prelude::* in discovery.rs",
        "Replace sequential for loop with rayon par_iter (uses all available CPUs by default)",
        "Collect errors from parallel operations properly using Mutex or channel",
        "Preserve cache fallback behavior for network errors",
        "Update module documentation to reflect parallel behavior is now default"
      ],
      "acceptance_criteria": [
        "clone_parallel() uses rayon for parallel iteration BY DEFAULT",
        "No CLI flag needed - parallel just works",
        "All errors are properly collected and reported",
        "Cache fallback still works for network errors",
        "Existing tests pass"
      ]
    },
    {
      "id": "add-unit-tests",
      "name": "Add unit tests for parallel cloning",
      "status": "complete",
      "priority": 4,
      "blocked_by": "implement-parallel-clone",
      "output_file": "src/phases/discovery.rs",
      "steps": [
        "Add test for parallel clone with multiple repos at same depth",
        "Add test for error collection from parallel operations",
        "Add test for cache fallback in parallel context",
        "Run cargo nextest run to verify tests pass"
      ],
      "acceptance_criteria": [
        "New tests cover parallel cloning scenarios",
        "All tests pass: cargo nextest run",
        "No clippy warnings"
      ]
    },
    {
      "id": "add-e2e-tests",
      "name": "Add E2E tests for parallel cloning",
      "status": "complete",
      "priority": 5,
      "blocked_by": "add-unit-tests",
      "output_file": "tests/cli_e2e_apply.rs",
      "steps": [
        "Add E2E test for apply with multiple inherited repos (verifies parallel works)",
        "Add E2E test for apply with nested inheritance (multiple depth levels)",
        "Add E2E test for error handling when clone fails",
        "Run cargo nextest run to verify tests pass"
      ],
      "acceptance_criteria": [
        "E2E tests verify parallel cloning works end-to-end",
        "E2E tests cover multi-repo and nested scenarios",
        "All tests pass: cargo nextest run"
      ]
    },
    {
      "id": "update-documentation",
      "name": "Update documentation for parallel cloning",
      "status": "complete",
      "priority": 6,
      "blocked_by": "add-e2e-tests",
      "output_files": ["docs/design.md", "context/completed/feature-status.json"],
      "steps": [
        "Update Phase 1 section in docs/design.md to reflect parallel is now default",
        "Update feature-status.json to mark parallelism as complete",
        "Remove 'parallelism deferred' notes",
        "Note that --parallel flag is optional override"
      ],
      "acceptance_criteria": [
        "Design doc reflects parallel is default behavior",
        "Feature status shows parallelism complete",
        "No outdated references to deferred parallelism"
      ]
    },
    {
      "id": "add-cli-parallel-override",
      "name": "(Optional) Add --parallel CLI flag for override",
      "status": "pending",
      "priority": 7,
      "blocked_by": "update-documentation",
      "output_files": ["src/cli.rs", "src/commands/apply.rs", "src/phases/discovery.rs"],
      "steps": [
        "Add --parallel <n> option to ApplyArgs in src/cli.rs",
        "Add COMMON_REPO_PARALLEL env var support",
        "Pass override value through pipeline to clone_parallel()",
        "Use rayon::ThreadPoolBuilder to limit threads when override specified",
        "Run cargo build to verify changes compile"
      ],
      "acceptance_criteria": [
        "--parallel flag overrides default parallelism",
        "COMMON_REPO_PARALLEL env var works as override",
        "Without flag, uses default (all CPUs)",
        "cargo build succeeds"
      ],
      "notes": "This task is optional - parallel works by default without it"
    },
    {
      "id": "add-e2e-tests-override",
      "name": "(Optional) Add E2E tests for --parallel override flag",
      "status": "pending",
      "priority": 8,
      "blocked_by": "add-cli-parallel-override",
      "output_file": "tests/cli_e2e_apply.rs",
      "steps": [
        "Add test for apply --parallel 1 (force sequential)",
        "Add test for COMMON_REPO_PARALLEL env var override",
        "Run cargo nextest run to verify tests pass"
      ],
      "acceptance_criteria": [
        "E2E tests verify --parallel override flag works",
        "E2E tests verify env var override works",
        "All tests pass: cargo nextest run"
      ],
      "notes": "Only needed if add-cli-parallel-override task is completed"
    }
  ],
  "notes": [
    "PARALLEL IS THE DEFAULT - no flag needed to enable it",
    "Rayon chosen over tokio to avoid async complexity throughout codebase",
    "Git clone is I/O-bound but rayon handles blocking I/O via thread pool",
    "--parallel flag and COMMON_REPO_PARALLEL env are OPTIONAL overrides",
    "Error handling must collect all parallel errors, not just first"
  ],
  "risks": [
    {
      "risk": "RepositoryManager may have interior mutability that breaks Sync",
      "mitigation": "Review struct carefully, wrap mutable parts in Mutex if needed"
    },
    {
      "risk": "Cache operations may need synchronization",
      "mitigation": "RepoCache already uses Arc<Mutex<>>, verify thread-safety"
    },
    {
      "risk": "Too many parallel clones could overwhelm network or git servers",
      "mitigation": "Default to reasonable limit (e.g., 8), allow user override"
    }
  ]
}
