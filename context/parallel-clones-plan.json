{
  "plan_name": "Parallel Clones Implementation",
  "last_updated": "2025-12-02",
  "session_startup": [
    "Run git status to check branch",
    "Run ./script/test in background to verify baseline",
    "Read this file to find current task",
    "Find first task where status=pending and blocked_by=null"
  ],
  "context": {
    "current_state": "clone_parallel() in src/phases/discovery.rs:277-334 is sequential despite its name. It already uses breadth-first traversal (all repos at depth N before depth N+1). The structure is ready for parallelization.",
    "design_goal": "Clone repos at same depth level in parallel. Total time determined by tree depth, not breadth. Performance target: execution time approaches minimum network transfer time.",
    "cli_requirements": {
      "flag": "--parallel <n> for apply command (default: auto)",
      "env_var": "COMMON_REPO_PARALLEL for default parallel clone operations"
    },
    "implementation_approach": "Use rayon for parallel iteration. While git clone is I/O-bound, rayon's thread pool handles blocking I/O fine by running multiple threads in parallel. This avoids async complexity.",
    "key_blocker": "RepositoryManager needs to be accessible across threads. Options: Arc wrapper, or Clone trait, or pass by reference with rayon's par_iter."
  },
  "tasks": [
    {
      "id": "add-rayon-dependency",
      "name": "Add rayon dependency to Cargo.toml",
      "status": "pending",
      "priority": 1,
      "blocked_by": null,
      "output_file": "Cargo.toml",
      "steps": [
        "Add rayon = \"1.10\" to [dependencies] in Cargo.toml",
        "Run cargo build to verify dependency resolves"
      ],
      "acceptance_criteria": [
        "rayon is listed in Cargo.toml dependencies",
        "cargo build succeeds"
      ]
    },
    {
      "id": "make-repo-manager-sync",
      "name": "Make RepositoryManager thread-safe for parallel access",
      "status": "pending",
      "priority": 2,
      "blocked_by": "add-rayon-dependency",
      "output_file": "src/repository.rs",
      "steps": [
        "Review RepositoryManager struct in src/repository.rs",
        "Ensure GitOperations and CacheOperations traits have Send + Sync bounds",
        "Verify RepositoryManager can be shared across threads (no interior mutability issues)",
        "Add Sync bound to RepositoryManager if needed",
        "Run cargo build to verify changes compile"
      ],
      "acceptance_criteria": [
        "RepositoryManager can be referenced from multiple threads",
        "cargo build succeeds",
        "Existing tests pass"
      ]
    },
    {
      "id": "add-parallel-config",
      "name": "Add parallel configuration to CLI and apply command",
      "status": "pending",
      "priority": 3,
      "blocked_by": "add-rayon-dependency",
      "output_files": ["src/cli.rs", "src/commands/apply.rs"],
      "steps": [
        "Add --parallel <n> option to ApplyArgs in src/cli.rs",
        "Add COMMON_REPO_PARALLEL env var support",
        "Default to num_cpus or auto-detect optimal parallelism",
        "Pass parallel config through to discovery phase",
        "Run cargo build to verify changes compile"
      ],
      "acceptance_criteria": [
        "--parallel flag is available on apply command",
        "COMMON_REPO_PARALLEL env var is read",
        "Default parallelism is auto-detected",
        "cargo build succeeds"
      ]
    },
    {
      "id": "implement-parallel-clone",
      "name": "Implement parallel cloning in clone_parallel()",
      "status": "pending",
      "priority": 4,
      "blocked_by": "make-repo-manager-sync",
      "output_file": "src/phases/discovery.rs",
      "steps": [
        "Import rayon::prelude::* in discovery.rs",
        "Update clone_parallel() signature to accept parallel count option",
        "Replace sequential for loop with rayon par_iter",
        "Configure rayon thread pool size based on parallel option",
        "Collect errors from parallel operations properly",
        "Preserve cache fallback behavior for network errors",
        "Update module documentation to reflect parallel behavior"
      ],
      "acceptance_criteria": [
        "clone_parallel() uses rayon for parallel iteration",
        "Thread pool size is configurable",
        "All errors are properly collected and reported",
        "Cache fallback still works for network errors",
        "Existing tests pass"
      ]
    },
    {
      "id": "wire-parallel-to-pipeline",
      "name": "Wire parallel config through pipeline",
      "status": "pending",
      "priority": 5,
      "blocked_by": ["add-parallel-config", "implement-parallel-clone"],
      "output_files": ["src/phases/discovery.rs", "src/commands/apply.rs"],
      "steps": [
        "Update discovery::execute() to accept parallel config",
        "Pass parallel config from apply command to discovery phase",
        "Ensure config flows through the entire pipeline",
        "Run cargo build to verify integration"
      ],
      "acceptance_criteria": [
        "--parallel flag value is used in clone_parallel()",
        "End-to-end config flow works",
        "cargo build succeeds"
      ]
    },
    {
      "id": "add-unit-tests",
      "name": "Add unit tests for parallel cloning",
      "status": "pending",
      "priority": 6,
      "blocked_by": "implement-parallel-clone",
      "output_file": "src/phases/discovery.rs",
      "steps": [
        "Add test for parallel clone with multiple repos at same depth",
        "Add test for parallel clone respects thread pool size",
        "Add test for error collection from parallel operations",
        "Add test for cache fallback in parallel context",
        "Run cargo nextest run to verify tests pass"
      ],
      "acceptance_criteria": [
        "New tests cover parallel cloning scenarios",
        "All tests pass: cargo nextest run",
        "No clippy warnings"
      ]
    },
    {
      "id": "add-e2e-tests",
      "name": "Add E2E tests for --parallel flag",
      "status": "pending",
      "priority": 7,
      "blocked_by": "wire-parallel-to-pipeline",
      "output_file": "tests/cli_e2e_apply.rs",
      "steps": [
        "Add test for apply --parallel 1 (sequential)",
        "Add test for apply --parallel 4 (parallel)",
        "Add test for COMMON_REPO_PARALLEL env var",
        "Run cargo nextest run to verify tests pass"
      ],
      "acceptance_criteria": [
        "E2E tests verify --parallel flag works",
        "E2E tests verify env var works",
        "All tests pass: cargo nextest run"
      ]
    },
    {
      "id": "update-documentation",
      "name": "Update documentation for parallel cloning",
      "status": "pending",
      "priority": 8,
      "blocked_by": "add-e2e-tests",
      "output_files": ["docs/design.md", "context/completed/feature-status.json"],
      "steps": [
        "Update Phase 1 section in docs/design.md to reflect implemented parallelism",
        "Update feature-status.json to mark parallelism as complete",
        "Remove 'parallelism deferred' notes",
        "Document thread pool configuration options"
      ],
      "acceptance_criteria": [
        "Design doc reflects current implementation",
        "Feature status shows parallelism complete",
        "No outdated references to deferred parallelism"
      ]
    }
  ],
  "notes": [
    "Rayon chosen over tokio to avoid async complexity throughout codebase",
    "Git clone is I/O-bound but rayon handles blocking I/O via thread pool",
    "Thread pool size configurable via --parallel flag or COMMON_REPO_PARALLEL env",
    "Default parallelism should be auto-detected (num_cpus or similar)",
    "Error handling must collect all parallel errors, not just first"
  ],
  "risks": [
    {
      "risk": "RepositoryManager may have interior mutability that breaks Sync",
      "mitigation": "Review struct carefully, wrap mutable parts in Mutex if needed"
    },
    {
      "risk": "Cache operations may need synchronization",
      "mitigation": "RepoCache already uses Arc<Mutex<>>, verify thread-safety"
    },
    {
      "risk": "Too many parallel clones could overwhelm network or git servers",
      "mitigation": "Default to reasonable limit (e.g., 8), allow user override"
    }
  ]
}
