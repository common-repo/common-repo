---
description: "Commit Workflow - Pre-commit checklist, conventional commits, CI/CD"
globs:
  - "**/*"
alwaysApply: true
---

# Commit Workflow

## Pre-Commit Checklist

**IMPORTANT**: Always follow this checklist before committing to avoid CI failures:

1. **Run prek (RECOMMENDED)**: Run `prek run --all-files` to automatically format, lint, and validate all files
   - This runs cargo fmt, cargo clippy, and all other pre-commit hooks automatically
   - Catches issues before committing
2. **Alternative - Run checks individually**:
   - **Format code**: Run `cargo fmt` to ensure consistent code formatting
   - **Run linting**: Run `cargo clippy --all-targets --all-features -- -D warnings` to catch warnings
   - **Run tests**: Run `./script/test` or `cargo test` to ensure all tests pass
3. **Update documentation**: If you've completed a feature, update `context/implementation-progress.md`
4. **Write conventional commit**: Ensure commit message is < 100 characters and follows format: `type(scope): description`
5. **Check branch name**: For agent branches, ensure name follows convention (e.g., `claude/feature-*`, `devin/{timestamp}-*`)

**Quick verification before push**:
```bash
# Run all CI checks locally
./script/cibuild

# Or run pre-commit hooks on all files (recommended)
prek run --all-files

# Or run checks individually
cargo fmt --check
cargo clippy --all-targets --all-features -- -D warnings
cargo test
```

**Common CI failures to avoid**:
- ❌ Commit message too long (>100 chars) → Use concise conventional commit format
- ❌ Code not formatted → Run `prek run --all-files` or `cargo fmt` before committing
- ❌ Clippy warnings → Run `prek run --all-files` or fix with `cargo clippy`
- ❌ Pre-commit hooks failed → Always run `prek run --all-files` before committing
- ❌ Branch name doesn't follow convention → Rename branch appropriately

## Commit Message Requirements

This repository enforces **conventional commits** via pre-commit hooks and CI. All commits must follow this format:

```
<type>(<scope>): <description>
```

Valid types: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `build`, `ci`, `chore`, `revert`

Examples:
- `feat: add user authentication module`
- `fix: resolve memory leak in data parser`
- `docs: update installation instructions`

Breaking changes require either:
- `feat!: breaking change description` or
- `BREAKING CHANGE:` in the commit footer

## Pre-commit Hooks

Pre-commit hooks are configured in `.pre-commit-config.yaml` and will automatically run:
- `cargo fmt` (formatting)
- `cargo check` (compilation)
- `cargo clippy` (linting with `-D warnings`)
- Conventional commit validation
- Trailing whitespace and YAML checks

If pre-commit hooks are not installed, install them with:

**Recommended (Rust-based, faster):**
```bash
# Install latest version from GitHub (crates.io version is outdated)
cargo install --git https://github.com/j178/prek --locked
prek install
prek install --hook-type commit-msg
```

**Alternative (Python-based):**
```bash
pip install pre-commit
pre-commit install
pre-commit install --hook-type commit-msg
```

**Note**: The `./script/setup` command automatically installs and configures prek if available.

## CI/CD Architecture

### GitHub Actions Workflows

1. **CI Pipeline** (`.github/workflows/ci.yml`)
   - Triggers on push/PR to `main`
   - **Lint job**: Runs pre-commit checks on all files (rustfmt, clippy, conventional commits validation, etc.)
   - **Test job**: Runs all tests with caching for cargo registry/index/build artifacts
   - **Rustfmt job**: Checks code formatting
   - **Clippy job**: Runs linting checks
   - **Build job**: Creates release binary

2. **Commit Linting** (`.github/workflows/commitlint.yml`)
   - Validates commit messages in PRs
   - Enforces conventional commit format

## Important Notes for Development

- **Lint job is required**: The CI pipeline includes a dedicated Lint job that runs pre-commit on all files. This job must pass for PRs to be merged.
- **Clippy is strict**: The project treats all clippy warnings as errors (`-D warnings`). Fix all warnings before committing.
- **Formatting is mandatory**: Code must be formatted with `cargo fmt` before commits will be accepted.
- **Commit messages are validated**: Both pre-commit hooks and CI will reject improperly formatted commit messages.
- **Prek installation**: Always install prek from GitHub (`cargo install --git https://github.com/j178/prek`) as the crates.io version (0.0.1) is outdated. The bootstrap script handles this automatically.
