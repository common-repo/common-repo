name: Auto Merge

on:
  pull_request:
    types: [labeled]

jobs:
  auto-merge:
    # Only run when the "ready to merge" label is applied
    if: github.event.label.name == 'ready to merge'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Generate App Token
        id: authenticate
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.COMMON_REPO_BOT_CLIENT_ID }}
          private-key: ${{ secrets.COMMON_REPO_BOT_PRIVATE_KEY }}

      - name: Wait for Checks and Verify Status
        env:
          GH_TOKEN: ${{ steps.authenticate.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_REPO: ${{ github.repository }}
        run: |
          echo "Checking status of PR #${PR_NUMBER}..."
          echo ""

          MAX_WAIT=120  # 2 minutes
          INTERVAL=10   # 10 seconds between retries
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Show current check status
            gh pr checks "${PR_NUMBER}" || true

            # Count in-progress checks (excluding this workflow to avoid counting ourselves)
            IN_PROGRESS=$(gh pr checks "${PR_NUMBER}" --json name,state \
              --jq '[.[] | select(.name | startswith("Auto Merge") | not) | select(.state == "PENDING" or .state == "IN_PROGRESS" or .state == "QUEUED")] | length')

            if [ "$IN_PROGRESS" -eq 0 ]; then
              echo ""
              echo "All checks have completed."
              break
            fi

            echo ""
            echo "Waiting for $IN_PROGRESS check(s) to complete... (${ELAPSED}s/${MAX_WAIT}s)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            echo ""
          done

          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "::warning::Timed out waiting for checks after ${MAX_WAIT}s. Proceeding with current status."
          fi

          # Count failed checks
          FAILED=$(gh pr checks "${PR_NUMBER}" --json name,state \
            --jq '[.[] | select(.state == "FAILURE" or .state == "ERROR")] | length')

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "::error::PR has $FAILED failed check(s). Fix failures before enabling auto-merge."
            exit 1
          fi

          echo ""
          echo "No failed checks. Proceeding with auto-merge."

      - name: Enable Auto-Merge
        env:
          GH_TOKEN: ${{ steps.authenticate.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_REPO: ${{ github.repository }}
        run: |
          echo "Enabling auto-merge for PR #${PR_NUMBER}..."
          gh pr merge "${PR_NUMBER}" --admin --rebase --delete-branch
          echo "Auto-merge enabled for PR #${PR_NUMBER}"
