name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: release-please

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - id: authenticate
        # actions/create-github-app-token@v2 - v2.0.6
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547
        with:
          app-id: ${{ secrets.COMMON_REPO_BOT_CLIENT_ID }}
          private-key: ${{ secrets.COMMON_REPO_BOT_PRIVATE_KEY }}

      - id: release
        # googleapis/release-please-action@v4 - v4.2.0
        uses: googleapis/release-please-action@a02a34c4d625f9be7cb89f09d5d8b28efb379746
        with:
          token: ${{ steps.authenticate.outputs.token }}

  build-binaries:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-14
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
    runs-on: ${{ matrix.os }}
    steps:
      # actions/checkout@v4 - v4.2.2
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Rust toolchain
        # dtolnay/rust-toolchain - master
        uses: dtolnay/rust-toolchain@a54c7afa936fefeb4456b2dd8068152669aa8203
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux)
        if: matrix.os == 'ubuntu-latest' && matrix.target != 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          case "${{ matrix.target }}" in
            x86_64-unknown-linux-musl)
              sudo apt-get install -y musl-tools
              ;;
            aarch64-unknown-linux-gnu)
              sudo apt-get install -y gcc-aarch64-linux-gnu
              ;;
          esac

      - name: Configure linker (aarch64-linux)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          mkdir -p .cargo
          echo '[target.aarch64-unknown-linux-gnu]' >> .cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> .cargo/config.toml

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Prepare binary (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          strip common-repo || true
          tar czvf ../../../common-repo-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.tar.gz common-repo

      - name: Prepare binary (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd target/${{ matrix.target }}/release
          Compress-Archive -Path common-repo.exe -DestinationPath ../../../common-repo-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.zip

      - name: Upload artifact
        # actions/upload-artifact@v4 - v4.5.0
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: common-repo-${{ matrix.target }}
          path: common-repo-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.${{ matrix.archive }}

  upload-release-assets:
    needs: [release-please, build-binaries]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        # actions/download-artifact@v4 - v4.2.1
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          path: artifacts
          merge-multiple: true

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          for file in artifacts/*; do
            gh release upload "${{ needs.release-please.outputs.tag_name }}" "$file" --clobber
          done
