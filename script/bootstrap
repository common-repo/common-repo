#!/usr/bin/env bash
# script/bootstrap: Resolve all dependencies that the application requires to run.

set -euo pipefail

cd "$(dirname "$0")/.."

echo "==> Bootstrapping common-repo..."

# Check if Rust is installed
if ! command -v cargo >/dev/null 2>&1; then
  echo "Error: Rust (cargo) not found. Install via https://rustup.rs/"
  exit 1
fi

echo "==> Ensuring Rust toolchain is installed..."
# Ensure toolchain installation happens (rust-toolchain.toml will pin the version)
rustup show >/dev/null 2>&1 || true

# Install cargo-binstall for faster binary installations
if ! command -v cargo-binstall >/dev/null 2>&1; then
  echo "==> Installing cargo-binstall..."
  SCRIPT_DIR="$(dirname "$0")"
  if [[ -x "${SCRIPT_DIR}/install-cargo-binstall" ]]; then
    "${SCRIPT_DIR}/install-cargo-binstall"
  else
    echo "    Warning: install-cargo-binstall script not found, skipping"
  fi
else
  echo "==> cargo-binstall is already installed ($(cargo-binstall -V))"
fi

# Install cargo-nextest if not already installed
if ! command -v cargo-nextest >/dev/null 2>&1; then
  echo "==> Installing cargo-nextest..."
  if command -v cargo-binstall >/dev/null 2>&1; then
    echo "    Using cargo-binstall for faster installation..."
    cargo binstall cargo-nextest --no-confirm
  else
    echo "    Installing via cargo install (this may take a few minutes)..."
    cargo install cargo-nextest --locked
  fi
  echo "    cargo-nextest installed successfully!"
else
  echo "==> cargo-nextest is already installed ($(cargo nextest --version))"
fi

# Install prek (Rust-based pre-commit alternative) if not already installed
# Note: prek must be installed from git because crates.io version (0.0.1) is outdated.
# cargo-binstall cannot be used here since it only supports crates.io releases.
if ! command -v prek >/dev/null 2>&1; then
  echo "==> Installing prek (Rust-based pre-commit)..."
  echo "    Installing latest version from GitHub (crates.io version is outdated)..."
  cargo install --git https://github.com/j178/prek --locked
  echo "    prek installed successfully!"
else
  echo "==> prek is already installed ($(prek --version))"
fi

# Install pre-commit as fallback if prek is not available
if ! command -v prek >/dev/null 2>&1 && ! command -v pre-commit >/dev/null 2>&1; then
  echo "==> Installing pre-commit as fallback..."
  if command -v pipx >/dev/null 2>&1; then
    pipx install pre-commit
  elif command -v pip >/dev/null 2>&1; then
    pip install --user pre-commit
  else
    echo "    Warning: Neither prek nor pre-commit could be installed."
    echo "    Install prek with: cargo install prek"
    echo "    Or install pre-commit with: pip install pre-commit"
  fi
fi

echo "==> Bootstrap complete!"
