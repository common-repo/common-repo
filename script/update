#!/usr/bin/env bash
# script/update: Update application to run for its current checkout.
#
# This script ensures the project is ready to run by:
# 1. Installing required tools (bootstrap)
# 2. Fetching dependencies
# 3. Building the project (if needed)
#
# Environment variables:
#   SKIP_BUILD=1 - Skip the cargo build step

set -euo pipefail

cd "$(dirname "$0")/.."

echo "==> Updating common-repo..."

# Ensure all dependencies are installed
./script/bootstrap

# Fetch dependencies without modifying Cargo.lock
echo "==> Fetching dependencies..."
cargo fetch

# Warm up the build cache (skip if SKIP_BUILD is set)
if [[ -n "${SKIP_BUILD:-}" ]]; then
  echo "==> Skipping build (SKIP_BUILD is set)"
else
  echo "==> Building project to warm cache..."
  cargo build
fi

echo "==> Update complete!"
