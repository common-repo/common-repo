######################
# CommonRepo v2 schema
#
# Operations are defined as a list of operators that are applied in
# deterministic order based on their declaration sequence.
#
# Each operator works on an in-memory filesystem representing the composite
# result of all previous operators. For consumers, the first operator is
# typically 'repo:' which pulls in files from an inherited repository. For
# producers, inheritance can be achieved by using 'repo:' to pull in an
# inherited repository (parent or ancestor), then applying further operators
# to add or mutate files from the current repository.
#
# This schema shows the user-friendly "original" format with compact syntax.
# The parser supports both this format and the more structured format used internally.
# For example, rename operations can use either:
# - Compact: [{"regex": "replacement"}]
# - Structured: [{from: "regex", to: "replacement"}]
#
# All examples in this file are automatically tested to ensure they parse correctly.

#########
# Core Operators

# repo: Pull files from an inherited repository into the in-memory filesystem
# The 'with:' parameter is optional syntactic sugar - operations listed in 'with:'
# are applied to this specific repo's files in its intermediate filesystem before
# compositing with other repos.
# The 'path:' parameter is optional - specifies a sub-path within the repository
# to use as the effective root. Only files under this path will be loaded.
- repo:
    url: https://github.com/shakefu/commonrepo
    ref: v1.1.0
    path: python/uv  # Optional: only load files under python/uv/ directory
    with:
      - include: [.*]
      - exclude: [.gitignore]
      - rename: [{".*\\.md": "docs/%[1]s"}]

# include: Add files from current repository based on glob patterns
- include:
    - "**/*"
    - .*/**/*
    - .gitignore

# exclude: Remove files from composite in-memory filesystem based on glob patterns
- exclude:
    - .github/workflows/template_*
    - "**/*.md"

# template: Mark files as templates to be processed with template variables
- template:
    - "templates/**"

# rename: Transform file paths using regex patterns with %[N]s placeholders
- rename:
    - "badname/(.*)": "goodname/%[1]s"
    - "^files/(.*)": "%[1]s"
    - "parent/([^/]+)/dir/(.*)": "%[1]s/%[2]s"
    - "(.*\\.md)": "docs/%[1]s"

# tools: Declare required tools with version constraints
- tools:
    - pre-commit: "*"
    - rustc: ">=1.70"
    - python: "^3.9"
    - node: "~18.0"

# template-vars: Template variables for file processing
- template-vars:
    project: ${PROJECT_NAME:-myprojectname}

#########
# Fragment Merge Operators
#
# Deterministically merge content fragments into structured files.
# A "fragment" is a partial file that gets merged into a complete destination file.

# yaml: Merge YAML fragments (source, dest, path, append, defer, auto-merge)
- yaml:
    source: fragment.yml
    dest: config.yml
    path: metadata.labels
    append: true

# json: Merge JSON fragments (source, dest, path, append, position, defer, auto-merge)
- json:
    source: fragment.json
    dest: package.json
    path: dependencies
    append: true
    position: end

# toml: Merge TOML fragments (source, dest, path, append, preserve-comments, defer, auto-merge)
- toml:
    source: fragment.toml
    dest: Cargo.toml
    path: dependencies
    append: true
    preserve-comments: true

# ini: Merge INI fragments (source, dest, section [optional], append, allow-duplicates, defer, auto-merge)
- ini:
    source: fragment.ini
    dest: config.ini
    section: database
    append: true
    allow-duplicates: false

# markdown: Merge markdown fragments (source, dest, section, append, level, position, create-section, defer, auto-merge)
- markdown:
    source: fragment.md
    dest: README.md
    section: "## Installation"
    append: true
    level: 2
    position: end
    create-section: true

#########
# Source-Declared Merge (defer and auto-merge)
#
# Source repos can declare merge operations that automatically apply when they
# are used as a dependency. Two syntax forms are available:
#
# 1. auto-merge: <file> - shorthand when source=dest (most common)
#    Sets source and dest to the same file and implies defer=true
#
# 2. defer: true + explicit source/dest - when paths differ
#
# These operations apply when the repo is inherited, before consumer's with: ops.

# Shorthand: auto-merge sets source=dest and implies defer
- markdown:
    auto-merge: CLAUDE.md
    section: "## Inherited Rules"
    append: true

# Verbose form: when source != dest
- yaml:
    source: labels.yaml
    dest: metadata.yaml
    path: metadata.labels
    defer: true

# Auto-merge works for all merge operators
- toml:
    auto-merge: Cargo.toml
    path: dependencies
